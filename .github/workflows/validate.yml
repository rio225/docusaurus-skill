name: Validate Skill

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate SKILL.md exists
        run: |
          if [ ! -f "skills/docusaurus/SKILL.md" ]; then
            echo "Error: SKILL.md not found"
            exit 1
          fi
          echo "✅ SKILL.md exists"

      - name: Validate frontmatter
        run: |
          # Check for required frontmatter fields
          if ! head -20 skills/docusaurus/SKILL.md | grep -q "^name:"; then
            echo "Error: Missing 'name' in frontmatter"
            exit 1
          fi
          if ! head -20 skills/docusaurus/SKILL.md | grep -q "^description:"; then
            echo "Error: Missing 'description' in frontmatter"
            exit 1
          fi
          echo "✅ Frontmatter valid"

      - name: Check SKILL.md line count
        run: |
          LINES=$(wc -l < skills/docusaurus/SKILL.md)
          echo "SKILL.md has $LINES lines"
          if [ "$LINES" -gt 500 ]; then
            echo "Warning: SKILL.md exceeds 500 lines ($LINES)"
          else
            echo "✅ SKILL.md is under 500 lines"
          fi

      - name: Validate scripts are executable
        run: |
          for script in skills/docusaurus/scripts/*.sh; do
            if [ -f "$script" ]; then
              if [ ! -x "$script" ]; then
                echo "Warning: $script is not executable"
              else
                echo "✅ $script is executable"
              fi
              # Check for shebang
              if ! head -1 "$script" | grep -q "^#!/bin/bash"; then
                echo "Warning: $script missing bash shebang"
              fi
            fi
          done

      - name: Validate JSON files
        run: |
          for json in skills/docusaurus/*.json; do
            if [ -f "$json" ]; then
              if python3 -m json.tool "$json" > /dev/null 2>&1; then
                echo "✅ $json is valid JSON"
              else
                echo "Error: $json is invalid JSON"
                exit 1
              fi
            fi
          done

      - name: Check reference files
        run: |
          REFS="skills/docusaurus/references"
          if [ -d "$REFS" ]; then
            echo "Reference files:"
            ls -la "$REFS"
            for ref in "$REFS"/*.md; do
              if [ -f "$ref" ]; then
                LINES=$(wc -l < "$ref")
                echo "  - $(basename "$ref"): $LINES lines"
              fi
            done
          fi

  package:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Create zip package
        run: |
          cd skills
          zip -r docusaurus.zip docusaurus/
          echo "Created docusaurus.zip"
          ls -la docusaurus.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docusaurus-skill
          path: skills/docusaurus.zip
          retention-days: 30
